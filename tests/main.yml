---
# Tasks for testing role

- name: Run win_domain_groups test
  hosts: "{{ win_domain_groups_testing_host }}"
  tasks:
    - name: Check test parameters existence
      assert:
        that:
          - test_ad_pdc is defined
          - test_ad_ou is defined
          - test_ad_group_ou is defined
          - test_ad_max_users is defined
          - test_domain_name is defined
          - test_ad_user is defined
          - test_ad_group is defined
          - test_domain_password is defined

    - name: Ensure win_domain_group is working
      block:
        - name: Ensure the RSAT-AD-PowerShell feature is installed
          win_feature:
            name:
              - RSAT-AD-PowerShell
            state: present
          register: ad_feature_result
          failed_when: false # HACK Fails in windows 10

        - name: Reboot host if required
          win_reboot:
          when: ad_feature_result.reboot_required | default(False)

        - name: Win ping
          win_ping:

        - name: Add test user
          win_domain_user:
            name: "{{ test_ad_user }}"
            upn: '{{ test_ad_user }}@{{ test_domain_name }}'
            password: '{{ test_domain_password }}'
            update_password: on_create
            state: present

        - name: Add test group
          win_domain_group:
            name: "{{ test_ad_group }}"
            scope: global
            path: "{{ test_ad_ou }}"
            state: present

        - name: Remove test group
          win_domain_group:
            name: "{{ test_ad_group }}"
            state: absent

        - name: Delete user
          win_domain_user:
            name: "{{ test_ad_user }}"
            domain_server: "{{ test_ad_pdc }}"
            state: absent
      tags: win_domain_groups::previous

    - name: Create test group
      include_role:
        name: amtega.win_domain_groups
      vars:
        win_domain_groups_defaults:
          scope: global
          category: security
          path: "{{ test_ad_ou }}"
        win_domain_groups:
          - name: my_group
            state: present
          - name: our_group
            state: present
          - name: your_group
            state: present
      tags: win_domain_groups::readme_example

    - name: Create test group (idempotence)
      include_role:
        name: amtega.win_domain_groups
      vars:
        win_domain_groups_defaults:
          scope: global
          category: security
          path: "{{ test_ad_ou }}"
        win_domain_groups:
          - name: my_group
            state: present
          - name: our_group
            state: present
          - name: your_group
            state: present
      tags: win_domain_groups::readme_example

    - name: Remove test group
      include_role:
        name: amtega.win_domain_groups
      vars:
        win_domain_groups_defaults:
          scope: global
          category: security
          path: "{{ test_ad_ou }}"
        win_domain_groups:
          - name: my_group
            state: absent
          - name: our_group
            state: absent
          - name: your_group
            state: absent
      tags: win_domain_groups::readme_example

    - name: Remove test group (idempotence)
      include_role:
        name: amtega.win_domain_groups
      vars:
        win_domain_groups_defaults:
          scope: global
          category: security
          path: "{{ test_ad_ou }}"
        win_domain_groups:
          - name: my_group
            state: absent
          - name: our_group
            state: absent
          - name: your_group
            state: absent
      tags: win_domain_groups::readme_example
