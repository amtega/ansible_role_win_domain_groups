---
# Tasks for testing role


- name: run win_domain_groups test
  gather_facts: no
  hosts: test_machines
  vars:
    test_ad_pdc: "{{ DC }}"
    test_ad_ou: "{{ TEST_AD_OU }}"
    test_ad_group_ou: "{{ TEST_AD_OU }}"
    test_ad_max_users: 4
    test_domain_name: "{{ DOMAIN_NETBIOS }}"  # Powershell $env:userdomain
    test_domain_password: "{{ ADMIN_PASSWORD }}"
    test_domain_username: "{{ ADMIN_USER }}"
    test_ad_user: ansible_test
    test_ad_group: ansible_test_group
    # ansible-windows/vagrant/inventory.yml have transport to basic, we need
    #  to rewrite it to work
    ansible_winrm_transport: credssp
  tasks:

    - name: ensure win_domain_group is working
      block:
        - name: ensure the RSAT-AD-PowerShell feature is installed
          win_feature:
            name:
              - RSAT-AD-PowerShell
            state: present
          register: ad_feature_result

        - name: reboot host if required
          win_reboot:
          when: ad_feature_result.reboot_required

        - name: win ping
          win_ping:
        # - name: "win ping {{ test_ad_pdc }}"
        #   win_ping:
        #   delegate_to: "{{ test_ad_pdc }}"
        #   run_once: true

        - name: add test user
          win_domain_user:
            name: "{{ test_ad_user }}"
            upn: '{{ test_ad_user }}@{{ test_domain_name }}'
            password: '{{ test_domain_password }}'
            update_password: on_create
            state: present

        - name: add test group
          win_domain_group:
            name: "{{ test_ad_group }}"
            scope: global
            path: "{{ test_ad_ou }}"
            state: present

        - name: remove test group
          win_domain_group:
            name: "{{ test_ad_group }}"
            state: absent

        - name: delete user
          win_domain_user:
            name: "{{ test_ad_user }}"
            domain_server: "{{ test_ad_pdc }}"
            state: absent

      tags: win_domain_users::previous

    - name: create test group
      include_role:
        name: amtega.win_domain_groups
      vars:
        win_domain_groups_defaults:
          scope: global
          category: security
          path: "{{ test_ad_ou }}"
        win_domain_groups:
          - name: my_group
            state: present
          - name: our_group
            state: present
          - name: your_group
            state: present

      tags:  win_domain_groups::readme_example

    - name: create test group (idempotence)
      include_role:
        name: amtega.win_domain_groups
      vars:
        win_domain_groups_defaults:
          scope: global
          category: security
          path: "{{ test_ad_ou }}"
        win_domain_groups:
          - name: my_group
            state: present
          - name: our_group
            state: present
          - name: your_group
            state: present

      tags:  win_domain_groups::readme_example

    - name: remove test group
      include_role:
        name: amtega.win_domain_groups
      vars:
        win_domain_groups_defaults:
          scope: global
          category: security
          path: "{{ test_ad_ou }}"
        win_domain_groups:
          - name: my_group
            state: absent
          - name: our_group
            state: absent
          - name: your_group
            state: absent

      tags:  win_domain_groups::readme_example

    - name: remove test group (idempotence)
      include_role:
        name: amtega.win_domain_groups
      vars:
        win_domain_groups_defaults:
          scope: global
          category: security
          path: "{{ test_ad_ou }}"
        win_domain_groups:
          - name: my_group
            state: absent
          - name: our_group
            state: absent
          - name: your_group
            state: absent

      tags:  win_domain_groups::readme_example
