---
# Tasks for testing role

- name: Run win_domain_groups test
  hosts: "{{ win_domain_groups_tests_host }}"
  tasks:

    - name: Create test group
      include_role:
        name: amtega.win_domain_groups
      vars:
        win_domain_groups_defaults:
          scope: global
          category: security
          path: "{{ win_domain_groups_tests_ad_ou }}"
        win_domain_groups:
          - name: my_group
            state: present
          - name: our_group
            state: present
          - name: your_group
            state: present

    - name: Create test group (idempotence)
      include_role:
        name: amtega.win_domain_groups
      vars:
        win_domain_groups_defaults:
          scope: global
          category: security
          path: "{{ win_domain_groups_tests_ad_ou }}"
        win_domain_groups:
          - name: my_group
            state: present
          - name: our_group
            state: present
          - name: your_group
            state: present

    - name: Remove test group
      include_role:
        name: amtega.win_domain_groups
      vars:
        win_domain_groups_defaults:
          scope: global
          category: security
          path: "{{ win_domain_groups_tests_ad_ou }}"
        win_domain_groups:
          - name: my_group
            state: absent
          - name: our_group
            state: absent
          - name: your_group
            state: absent

    - block:
        - name: Remove test group (idempotence)
          include_role:
            name: amtega.win_domain_groups
          vars:
            win_domain_groups_defaults:
              scope: global
              category: security
              path: "{{ win_domain_groups_tests_ad_ou }}"
            win_domain_groups:
              - name: my_group
                state: absent
              - name: our_group
                state: absent
              - name: your_group
                state: absent
      tags:
        - cleanup
